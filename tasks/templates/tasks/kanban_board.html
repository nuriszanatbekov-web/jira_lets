<!DOCTYPE html>
<html lang="ky">
<head>
    <meta charset="UTF-8">
    <title>Django Kanban –¢–∞–∫—Ç–∞—Å—ã</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f4f5f7; font-family: "Segoe UI", Roboto, sans-serif; }
        .navbar { background: #0747A6; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;}
        .navbar-brand { color: #fff !important; font-weight: bold; font-size: 22px; }

        .add-task-btn {
            background: #0052CC;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .add-task-btn:hover { background: #0065FF; }

        .form-box { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 6px rgba(9,30,66,0.2); margin-bottom: 25px; }
        .kanban-columns { display: flex; gap: 20px; align-items: flex-start; width: 100%; }
        .kanban-column { background: #ebecf0; padding: 15px; border-radius: 6px; width: 33%; min-height: 400px; box-shadow: 0 1px 3px rgba(9,30,66,0.2); }
        .kanban-column h2 { font-size: 20px; color: #172b4d; margin-bottom: 15px; }
        .task-card {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 6px solid #4c9aff;
            box-shadow: 0 1px 3px rgba(9,30,66,0.2);
            transition: 0.2s;
            cursor: grab;
            min-width: 0;
            word-wrap: break-word;
        }
        .task-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(9,30,66,0.25); }
        .todo { border-left-color: #4c9aff; }
        .progress { border-left-color: #ff991f; }
        .done { border-left-color: #36b37e; }
        .task-card p { margin: 0; font-size: 15px; line-height: 1.4; }
        .task-card strong { font-size: 17px; display: block; margin-bottom: 6px; }

        /* --- –û“¢–î–û–û–õ–û–†: –°–ê–ù–î–ê–†–î–´–ù –ö–´–°–´–õ–£–£–°–£–ù –ñ–ê–ù–ê –ë–ê–°–ö–´–ß–¢–ê–†–î–´ –ñ–ê–ö–®–´–†–¢–£–£ --- */
        .task-card form {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #dcdcdc;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .task-card select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #b8b8b8;
            flex-grow: 1;
            min-width: 50px;
        }
        .task-card button {
            background: #0747A6;
            color: white;
            border: none;
            padding: 6px 8px; /* –ö–∏—á–∏–Ω–µ–∫–µ–π padding */
            border-radius: 4px;
            margin-left: 0;
            white-space: nowrap;
            font-size: 12px; /* –ö–∏—á–∏–Ω–µ–∫–µ–π —à—Ä–∏—Ñ—Ç */
            line-height: 1;
        }
        .task-card .delete-btn {
            background: #ff5248;
            margin-top: 5px;
            display: block;
            width: 100%;
        }
        /* --- –û“¢–î–û–û–õ–û–† –ê–Ø–ö–¢–ê–î–´ --- */

        .drag-over { background-color: #dfe6f0; }
        .hide { display: none; }
    </style>
    <style>
    /* --- –ù–ï–ì–ò–ó–ì–ò ”®–ó–ì”®–†–¢“Æ“Æ: –§–û–ù–î–£ –ö–ê–†–ê –ö”®–ö–ö”® –ê–õ–ú–ê–®–¢–´–†–£–£ --- */
    body {
        background-color: #172B4D; /* –ö–∞—Ä–∞“£–≥—ã –∫”©–∫ —Ñ–æ–Ω */
        font-family: "Segoe UI", Roboto, sans-serif;
        color: #f4f5f7; /* –ñ–∞–ª–ø—ã —Ç–µ–∫—Å—Ç—Ç–∏–Ω —Ç“Ø—Å“Ø –∞–∫–∫–∞ ”©–∑–≥”©—Ä—Ç“Ø–ª–¥“Ø */
    }

    .navbar { background: #0747A6; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;}
    .navbar-brand { color: #fff !important; font-weight: bold; font-size: 22px; }

    .add-task-btn {
        background: #0052CC;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .add-task-btn:hover { background: #0065FF; }

    /* --- –§–û–†–ú–ê –ñ–ê–ù–ê –ö–û–õ–û–ù–ö–ê –ö–û–ù–¢–ï–ô–ù–ï–†–õ–ï–†–ò–ù–î–ï–ì–ò ”®–ó–ì”®–†–¢“Æ“Æ–õ”®–† --- */
    .form-box {
        background: #283e60; /* –§–æ—Ä–º–∞–Ω—ã–Ω —Ñ–æ–Ω—É –±–∏—Ä –∞–∑ –∞—á—ã–≥—ã—Ä–∞–∞–∫ –∫–∞—Ä–∞ –∫”©–∫ */
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.5); /* –ö”©–º“Ø—Å–∫”©–Ω“Ø –∫“Ø—á”©—Ç—Ç“Ø–∫ */
        margin-bottom: 25px;
    }
    .kanban-columns { display: flex; gap: 20px; align-items: flex-start; width: 100%; }
    .kanban-column {
        background: #21304A; /* –ö–æ–ª–æ–Ω–∫–∞–Ω—ã–Ω —Ñ–æ–Ω—É –∫–∞—Ä–∞ –∫”©–∫ */
        padding: 15px;
        border-radius: 6px;
        width: 33%;
        min-height: 400px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.4);
    }
    .kanban-column h2 {
        font-size: 20px;
        color: #f4f5f7; /* –ö–æ–ª–æ–Ω–∫–∞–Ω—ã–Ω –∞—Ç–∞–ª—ã—à—ã–Ω –∞–∫ –∫—ã–ª–¥—ã–∫ */
        margin-bottom: 15px;
    }

    /* --- –¢–ê–ü–®–´–†–ú–ê –ö–ê–†–¢–û–ß–ö–ê–õ–ê–†–´–ù–´–ù ”®–ó–ì”®–†–¢“Æ“Æ–õ”®–†“Æ --- */
    .task-card {
        background: #384C6C; /* –ö–∞—Ä—Ç–æ—á–∫–∞–Ω—ã–Ω —Ñ–æ–Ω—É –∞–Ω–¥–∞–Ω –¥–∞ –∞—á—ã–≥—ã—Ä–∞–∞–∫ */
        color: #f4f5f7; /* –ö–∞—Ä—Ç–æ—á–∫–∞–¥–∞–≥—ã —Ç–µ–∫—Å—Ç –∞–∫ */
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 12px;
        border-left: 6px solid #4c9aff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        transition: 0.2s;
        cursor: grab;
        min-width: 0;
        word-wrap: break-word;
    }
    .task-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.6); }
    .todo { border-left-color: #4c9aff; }
    .progress { border-left-color: #ff991f; }
    .done { border-left-color: #36b37e; }
    .task-card p { margin: 0; font-size: 15px; line-height: 1.4; }
    .task-card strong { font-size: 17px; display: block; margin-bottom: 6px; }

    .task-card form {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed #dcdcdc;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    /* –°–µ–ª–µ–∫—Ç –∂–∞–Ω–∞ –ò–Ω–ø—É—Ç—Ç–∞—Ä–¥—ã –∫–∞—Ä–∞“£–≥—ã —Ñ–æ–Ω–≥–æ —ã–ª–∞–π—ã–∫—Ç–∞—à—Ç—ã—Ä—É—É */
    .task-card select, .form-box input, .form-box textarea, .form-box select {
        padding: 5px;
        border-radius: 4px;
        border: 1px solid #5e7090;
        background-color: #21304A; /* –§–æ–Ω –∫–∞—Ä–∞“£–≥—ã */
        color: #f4f5f7; /* –¢–µ–∫—Å—Ç –∞–∫ */
        flex-grow: 1;
        min-width: 50px;
    }

    .task-card button {
        background: #0747A6;
        color: white;
        padding: 6px 8px;
        border-radius: 4px;
        margin-left: 0;
        white-space: nowrap;
        font-size: 12px;
        line-height: 1;
    }
    .task-card .delete-btn {
        background: #ff5248;
        margin-top: 5px;
        display: block;
        width: 100%;
    }

    .drag-over { background-color: #283e60; } /* Drag-over —Ñ–æ–Ω—É–Ω –¥–∞ –∫–∞—Ä–∞“£–≥—ã–ª–∞—Ç—É—É */
    .hide { display: none; }
</style>
</head>
<body>
<nav class="navbar px-4">
    <a class="navbar-brand" href="#">–î–∂–∏—Ä–∞-–°—Ç–∏–ª—å –ö–∞–Ω–±–∞–Ω</a>
    <button id="toggle-form-btn" class="add-task-btn">
        ‚ûï –¢–∞–ø—à—ã—Ä–º–∞ –ö–æ—à—É—É
    </button>
</nav>

<div class="container mt-4">
    <div id="new-task-form-container" class="form-box hide">
        <h3 class="mb-3">‚ûï –ñ–∞“£—ã –¢–∞–ø—à—ã—Ä–º–∞ –ö–æ—à—É—É</h3>
        <form id="add-task-form" method="post" action="{% url 'kanban_board' %}">
            {% csrf_token %}
            {{ form.as_p }}
            <button class="btn btn-primary">–¢–∞–ø—à—ã—Ä–º–∞ –∫–æ—à—É—É</button>
        </form>
    </div>

    <div class="kanban-columns">
        <div class="kanban-column" data-status="TODO">
            <h2>üü¶ Todo ({{ todo_tasks|length }})</h2>
            {% for task in todo_tasks %}
            <div class="task-card todo" data-id="{{ task.id }}">
                <strong>{{ task.title }}</strong>
                <p>{{ task.description|truncatechars:120 }}</p>
                <form method="post" action="{% url 'update_status' task.id %}">
                    {% csrf_token %}
                    <select name="new_status">
                        <option value="TODO" selected>Todo</option>
                        <option value="IN_PROGRESS">Progress</option>
                        <option value="DONE">Done</option>
                    </select>
                    <button>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
                </form>
                <button class="btn btn-danger btn-sm delete-btn" style="margin-top:5px;">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
            </div>
            {% empty %}<p></p>{% endfor %}
        </div>

        <div class="kanban-column" data-status="IN_PROGRESS">
            <h2>üüß Progress ({{ progress_tasks|length }})</h2>
            {% for task in progress_tasks %}
            <div class="task-card progress" data-id="{{ task.id }}">
                <strong>{{ task.title }}</strong>
                <p>{{ task.description|truncatechars:120 }}</p>
                <form method="post" action="{% url 'update_status' task.id %}">
                    {% csrf_token %}
                    <select name="new_status">
                        <option value="TODO">Todo</option>
                        <option value="IN_PROGRESS" selected>Progress</option>
                        <option value="DONE">Done</option>
                    </select>
                    <button>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
                </form>
                <button class="btn btn-danger btn-sm delete-btn" style="margin-top:5px;">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
            </div>
            {% empty %}<p></p>{% endfor %}
        </div>

        <div class="kanban-column" data-status="DONE">
            <h2>üü© Done ({{ done_tasks|length }})</h2>
            {% for task in done_tasks %}
            <div class="task-card done" data-id="{{ task.id }}">
                <strong>{{ task.title }}</strong>
                <p>{{ task.description|truncatechars:120 }}</p>
                <form method="post" action="{% url 'update_status' task.id %}">
                    {% csrf_token %}
                    <select name="new_status">
                        <option value="TODO">Todo</option>
                        <option value="IN_PROGRESS">Progress</option>
                        <option value="DONE" selected>Done</option>
                    </select>
                    <button>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
                </form>
                <button class="btn btn-danger btn-sm delete-btn" style="margin-top:5px;">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
            </div>
            {% empty %}<p></p>{% endfor %}
        </div>
    </div>
</div>

<script>
// --- –ñ–ê“¢–´ –§–£–ù–ö–¶–ò–Ø: –°–ê–ù–î–ê–†–î–´ –≠–°–ï–ü–¢”®”® –§–£–ù–ö–¶–ò–Ø–°–´ ---
function updateTaskCount(columnElement, change) {
    const header = columnElement.querySelector('h2');
    if (!header) return;

    const text = header.textContent;
    const match = text.match(/\((.*?)\)/);

    if (match) {
        let currentCount = parseInt(match[1]);
        let newCount = currentCount + change;

        const newText = text.replace(`(${currentCount})`, `(${newCount})`);
        header.textContent = newText;
    }
}
// --- –ñ–ê“¢–´ –§–£–ù–ö–¶–ò–Ø –ê–Ø–ö–¢–ê–î–´ ---

document.addEventListener("DOMContentLoaded", () => {

    const columns = document.querySelectorAll(".kanban-column");
    const toggleButton = document.getElementById("toggle-form-btn");
    const formContainer = document.getElementById("new-task-form-container");

    toggleButton.addEventListener("click", () => {
        formContainer.classList.toggle("hide");

        if (formContainer.classList.contains("hide")) {
            toggleButton.textContent = "‚ûï –¢–∞–ø—à—ã—Ä–º–∞ –ö–æ—à—É—É";
        } else {
            toggleButton.textContent = "‚ùå –§–æ—Ä–º–∞–Ω—ã –ñ–∞–±—É—É";
        }
    });


    function makeDraggable(card){
        card.setAttribute("draggable", "true");
        card.addEventListener("dragstart", e => {
            e.dataTransfer.setData("text/plain", card.dataset.id);
            setTimeout(() => card.classList.add("hide"), 0);
        });
        card.addEventListener("dragend", () => card.classList.remove("hide"));

        // Delete –∫–Ω–æ–ø–∫–∞ (–û—Ç–∫–ª—é—á–∏—Ç—å –±–∞—Å–∫—ã—á—ã)
        const deleteBtn = card.querySelector(".delete-btn");
        if(deleteBtn){
            deleteBtn.addEventListener("click", async () => {
                if(confirm("–ß—ã–Ω—ã–Ω–¥–∞ ”©—á“Ø—Ä”©—Å“Ø–∑–±“Ø?")){
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    const response = await fetch(`/delete/${card.dataset.id}/`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": csrfToken,
                            "X-Requested-With": "XMLHttpRequest"
                        }
                    });
                    const data = await response.json();
                    if(data.success) {
                        const currentColumn = card.closest(".kanban-column");
                        card.remove();
                        // --- –ñ–ê“¢–´ –õ–û–ì–ò–ö–ê: ”®–ß“Æ–†“Æ“Æ–î”® –°–ê–ù–î–´ –ö–ï–ú–ò–¢“Æ“Æ ---
                        updateTaskCount(currentColumn, -1);
                        // --- –ñ–ê“¢–´ –õ–û–ì–ò–ö–ê –ê–Ø–ö–¢–ê–î–´ ---
                    }
                    else alert("”®—á“Ø—Ä“Ø–ª–±”©–¥“Ø!");
                }
            });
        }
    }

    document.querySelectorAll(".task-card").forEach(makeDraggable);

    columns.forEach(column => {
        column.addEventListener("dragover", e => { e.preventDefault(); column.classList.add("drag-over"); });
        column.addEventListener("dragleave", e => column.classList.remove("drag-over"));
        column.addEventListener("drop", e => {
            e.preventDefault();
            column.classList.remove("drag-over");
            const id = e.dataTransfer.getData("text/plain");
            const card = document.querySelector(`.task-card[data-id='${id}']`);

            // --- –ñ–ê“¢–´ –õ–û–ì–ò–ö–ê: –≠–°–ö–ò –ö–û–õ–û–ù–ö–ê–ù–´ –¢–ê–ë–£–£ ---
            const oldColumn = card.closest(".kanban-column");
            // --- –ñ–ê“¢–´ –õ–û–ì–ò–ö–ê –ê–Ø–ö–¢–ê–î–´ ---

            const newStatus = column.dataset.status;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Django –∞—Ä–∫—ã–ª—É—É —Å—Ç–∞—Ç—É—Å –∂–∞“£—ã—Ä—Ç—É—É (Drop –ª–æ–≥–∏–∫–∞—Å—ã–Ω–∞ –∫–æ—à—É–ª–¥—É)
            fetch(`/update/${id}/`, {
                method: "POST",
                body: `new_status=${newStatus}&csrfmiddlewaretoken=${csrfToken}`,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            }).then(response => {
                if(response.ok) {

                    // --- –ñ–ê“¢–´ –õ–û–ì–ò–ö–ê: –°–ê–ù–î–ê–†–î–´ –ñ–ê“¢–´–†–¢–£–£ ---
                    if (oldColumn && oldColumn !== column) {
                        updateTaskCount(oldColumn, -1); // –≠—Å–∫–∏ –∫–æ–ª–æ–Ω–∫–∞–¥–∞–Ω 1–¥–∏ –∫–µ–º–∏—Ç–µ—Ç
                        updateTaskCount(column, 1);     // –ñ–∞“£—ã –∫–æ–ª–æ–Ω–∫–∞–≥–∞ 1–¥–∏ –∫–æ—à–æ—Ç
                    }
                    // --- –ñ–ê“¢–´ –õ–û–ì–ò–ö–ê –ê–Ø–ö–¢–ê–î–´ ---

                    column.appendChild(card);
                    card.classList.remove("todo", "progress", "done");
                    card.classList.add(newStatus.toLowerCase());
                    const select = card.querySelector('select[name="new_status"]');
                    if(select) select.value = newStatus;
                } else {
                    alert("–°—Ç–∞—Ç—É—Å –∂–∞“£—ã—Ä—Ç—ã–ª–±–∞–π –∫–∞–ª–¥—ã!");
                }
            });
        });
    });

    // AJAX –∫–æ—à—É—É
    const form = document.getElementById("add-task-form");
    form.addEventListener("submit", async e => {
        e.preventDefault();
        const formData = new FormData(form);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const response = await fetch(form.action, {
            method: "POST",
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await response.json();
        if(data.success){
            const column = document.querySelector(`.kanban-column[data-status="${data.status}"]`);
            const div = document.createElement("div");
            div.className = `task-card ${data.status.toLowerCase()}`;
            div.dataset.id = data.id;
            div.innerHTML = `<strong>${data.title}</strong>
                             <p>${data.description}</p>
                             <form method="post" action="/update/${data.id}/">
                                <select name="new_status">
                                    <option value="TODO" ${data.status=="TODO"?"selected":""}>Todo</option>
                                    <option value="IN_PROGRESS" ${data.status=="IN_PROGRESS"?"selected":""}>Progress</option>
                                    <option value="DONE" ${data.status=="DONE"?"selected":""}>Done</option>
                                </select>
                                <button>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
                             </form>
                             <button class="btn btn-danger btn-sm delete-btn" style="margin-top:5px;">–û—Ç–∫–ª—é—á–∏—Ç—å</button>`;
            column.appendChild(div);
            makeDraggable(div);
            form.reset();

            // --- –ñ–ê“¢–´ –õ–û–ì–ò–ö–ê: –ö–û–®–£–£–î–ê–ù –ö–ò–ô–ò–ù –°–ê–ù–î–´ –ñ–ê“¢–´–†–¢–£–£ ---
            updateTaskCount(column, 1); // –ñ–∞“£—ã –∫–æ–ª–æ–Ω–∫–∞–≥–∞ 1–¥–∏ –∫–æ—à–æ—Ç
            // --- –ñ–ê“¢–´ –õ–û–ì–ò–ö–ê –ê–Ø–ö–¢–ê–î–´ ---

            formContainer.classList.add("hide");
            toggleButton.textContent = "‚ûï –¢–∞–ø—à—ã—Ä–º–∞ –ö–æ—à—É—É";

        } else alert("–¢–∞–ø—à—ã—Ä–º–∞ –∫–æ—à—É–ª–±–∞–π –∫–∞–ª–¥—ã!");
    });
});
</script>
</body>
</html>