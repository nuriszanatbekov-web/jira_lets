{% extends "base.html" %}

{% block title %}–ö–∞–Ω–±–∞–Ω –¢–∞–∫—Ç–∞—Å—ã{% endblock %}

{% block head %}
    <style>
        /* --- –°–¢–ò–õ–¨ –ë–õ–û–ì–£ --- */

        .form-box {
            background: #283e60;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
            margin-bottom: 25px;
        }
        .kanban-columns {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            width: 100%;
        }
        .kanban-column {
            background: #21304A;
            padding: 15px;
            border-radius: 6px;
            width: 33%;
            min-height: 400px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
            flex-grow: 1;
        }
        .kanban-column h2 {
            font-size: 20px;
            color: #f4f5f7;
            margin-bottom: 15px;
        }

        .task-card {
            background: #384C6C;
            color: #f4f5f7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 6px solid #4c9aff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transition: 0.2s;
            cursor: grab;
            min-width: 0;
            word-wrap: break-word;
        }
        .task-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.6); }
        .todo { border-left-color: #4c9aff; }
        .progress { border-left-color: #ff991f; }
        .done { border-left-color: #36b37e; }
        .task-card p { margin: 0; font-size: 15px; line-height: 1.4; }
        .task-card strong { font-size: 17px; display: block; margin-bottom: 6px; }

        .task-card form {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #5e7090;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .task-card select, .form-box input, .form-box textarea, .form-box select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #5e7090;
            background-color: #21304A;
            color: #f4f5f7;
            flex-grow: 1;
            min-width: 50px;
        }

        .task-card button {
            background: #0747A6;
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            margin-left: 0;
            white-space: nowrap;
            font-size: 12px;
            line-height: 1;
        }
        .task-card .delete-btn {
            background: #ff5248;
            margin-top: 5px;
            display: block;
            width: 100%;
        }

        .task-card .task-info {
            border-bottom: 1px dotted #5e7090;
            padding-bottom: 5px;
            margin-bottom: 8px;
        }
        .task-card .task-author strong {
            font-size: 13px;
            display: inline;
            color: #A6C5E2;
        }
        .task-card .created-at-time {
            font-size: 12px;
            color: #A6C5E2 !important;
            opacity: 0.8;
        }

        .assignees-container {
            margin-top: 8px;
            display: flex;
            justify-content: flex-end;
            gap: 3px;
        }
        .programmer-icon {
            font-size: 1.5em;
            color: #505F79;
            line-height: 1;
        }

        /* --- –ñ–ê–®–´–†–£–£ –ö–õ–ê–°–°–´–ù –¢–ï–ö–®–ï–†“Æ“Æ --- */
        .hide {
            display: none;
        }

    </style>
{% endblock %}

{% block content %}

    <div class="modal fade" id="taskDetailsModal" tabindex="-1" aria-labelledby="taskDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background-color: #21304A; color: #f4f5f7;">
                <div class="modal-header" style="border-bottom: 1px solid #384C6C;">
                    <h5 class="modal-title" id="taskDetailsModalLabel">–¢–∞–ø—à—ã—Ä–º–∞: <span id="modal-title"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                    <p><strong>ID:</strong> <span id="modal-id"></span></p>
                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="modal-status"></span></p>
                    <p><strong>–¢“Ø–∑“Ø–ª–≥”©–Ω:</strong> <span id="modal-created-at"></span></p>

                    <p><strong>–ñ–æ–æ–ø—Ç—É—É:</strong> <span id="modal-assignee"></span></p>
                    <hr style="border-top: 1px solid #384C6C;">
                    <h5>–ö—ã—Å–∫–∞—á–∞ –°“Ø—Ä”©—Ç—Ç”©–º”© (–ö–∞—Ä—Ç–∞–¥–∞ –∫”©—Ä“Ø–Ω–≥”©–Ω):</h5>
                    <p id="modal-short-description" style="white-space: pre-wrap;"></p>
                    <hr style="border-top: 1px solid #384C6C;">
                    <h5>–ü–æ–¥—Ä–æ–±–Ω–µ–µ (–¢–æ–ª—É–∫ –°“Ø—Ä”©—Ç—Ç”©–º”©):</h5>
                    <p id="modal-full-description" style="white-space: pre-wrap;">–ú–∞–∞–ª—ã–º–∞—Ç –∂–æ–∫</p>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #384C6C;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background: #384C6C; border: none;">–ñ–∞–±—É—É</button>
                </div>
            </div>
        </div>
    </div>

    <div id="new-task-form-container" class="form-box hide">
        <h3 class="mb-3">‚ûï –ñ–∞“£—ã –¢–∞–ø—à—ã—Ä–º–∞ –ö–æ—à—É—É</h3>
        <form id="add-task-form" method="post" action="{% url 'kanban_board' %}">
            {% csrf_token %}
            {{ form.as_p }}
            <button class="btn btn-primary">–¢–∞–ø—à—ã—Ä–º–∞ –∫–æ—à—É—É</button>
        </form>
    </div>

    <div class="kanban-columns">

        <div class="kanban-column" data-status="TODO">
            <h2>üü¶ Todo ({{ todo_tasks|length }})</h2>
            {% for task in todo_tasks %}
            <div class="task-card todo"
                data-id="{{ task.id }}"
                data-title="{{ task.title }}"
                data-short-description="{{ task.description|truncatechars:120 }}"
                data-full-description="{{ task.full_description|default:'' }}"
                data-status="TODO"
                data-created-at="{{ task.created_at|date:'M d, H:i' }}">

                <div class="task-info d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted task-author">
                        –ê–≤—Ç–æ—Ä—É: <strong>{% if task.author %}{{ task.author.username }}{% else %}(–ë–µ–ª–≥–∏—Å–∏–∑){% endif %}</strong>
                    </small>
                    <small class="text-secondary created-at-time" title="–¢“Ø–∑“Ø–ª–≥”©–Ω —É–±–∞–∫—ã—Ç—ã">
                        <i class="fas fa-clock"></i> {{ task.created_at|date:"M d, H:i" }}
                    </small>
                </div>

                <strong>{{ task.title }}</strong>
                <p>{{ task.description|truncatechars:120 }}</p>

                {% with assignees=task.assigned_to.all %}
                    {% if assignees %}
                        <div class="assignees-container">
                            {% for assignee in assignees %}
                                <span class="programmer-icon" title="–î–∞–π—ã–Ω–¥–∞–ª–≥–∞–Ω: {{ assignee.username }}">
                                    <i class="fas fa-user-circle"></i>
                                </span>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}
                <form method="post" action="{% url 'update_status' task.id %}" class="update-status-form">
                    {% csrf_token %}
                    <select name="new_status">
                        <option value="TODO" selected>Todo</option>
                        <option value="IN_PROGRESS">Progress</option>
                        <option value="DONE">Done</option>
                    </select>
                    <button>–û–±–Ω–æ–≤–∏—Ç—å</button>
                </form>
                <button class="btn btn-danger btn-sm delete-btn" style="margin-top:5px;">”®—á“Ø—Ä“Ø“Ø</button>
            </div>
            {% empty %}<p></p>{% endfor %}
        </div>

        <div class="kanban-column" data-status="IN_PROGRESS">
            <h2>üüß Progress ({{ progress_tasks|length }})</h2>
            {% for task in progress_tasks %}
            <div class="task-card progress"
                data-id="{{ task.id }}"
                data-title="{{ task.title }}"
                data-short-description="{{ task.description|truncatechars:120 }}"
                data-full-description="{{ task.full_description|default:'' }}"
                data-status="IN_PROGRESS"
                data-created-at="{{ task.created_at|date:'M d, H:i' }}">

                <div class="task-info d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted task-author">
                        –ê–≤—Ç–æ—Ä—É: <strong>{% if task.author %}{{ task.author.username }}{% else %}(–ë–µ–ª–≥–∏—Å–∏–∑){% endif %}</strong>
                    </small>
                    <small class="text-secondary created-at-time" title="–¢“Ø–∑“Ø–ª–≥”©–Ω —É–±–∞–∫—ã—Ç—ã">
                        <i class="fas fa-clock"></i> {{ task.created_at|date:"M d, H:i" }}
                    </small>
                </div>

                <strong>{{ task.title }}</strong>
                <p>{{ task.description|truncatechars:120 }}</p>

                {% with assignees=task.assigned_to.all %}
                    {% if assignees %}
                        <div class="assignees-container">
                            {% for assignee in assignees %}
                                <span class="programmer-icon" title="–î–∞–π—ã–Ω–¥–∞–ª–≥–∞–Ω: {{ assignee.username }}">
                                    <i class="fas fa-user-circle"></i>
                                </span>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}
                <form method="post" action="{% url 'update_status' task.id %}" class="update-status-form">
                    {% csrf_token %}
                    <select name="new_status">
                        <option value="TODO">Todo</option>
                        <option value="IN_PROGRESS" selected>Progress</option>
                        <option value="DONE">Done</option>
                    </select>
                    <button>–û–±–Ω–æ–≤–∏—Ç—å</button>
                </form>
                <button class="btn btn-danger btn-sm delete-btn" style="margin-top:5px;">”®—á“Ø—Ä“Ø“Ø</button>
            </div>
            {% empty %}<p></p>{% endfor %}
        </div>

        <div class="kanban-column" data-status="DONE">
            <h2>üü© Done ({{ done_tasks|length }})</h2>
            {% for task in done_tasks %}
            <div class="task-card done"
                data-id="{{ task.id }}"
                data-title="{{ task.title }}"
                data-short-description="{{ task.description|truncatechars:120 }}"
                data-full-description="{{ task.full_description|default:'' }}"
                data-status="DONE"
                data-created-at="{{ task.created_at|date:'M d, H:i' }}">

                <div class="task-info d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted task-author">
                        –ê–≤—Ç–æ—Ä—É: <strong>{% if task.author %}{{ task.author.username }}{% else %}(–ë–µ–ª–≥–∏—Å–∏–∑){% endif %}</strong>
                    </small>
                    <small class="text-secondary created-at-time" title="–¢“Ø–∑“Ø–ª–≥”©–Ω —É–±–∞–∫—ã—Ç—ã">
                        <i class="fas fa-clock"></i> {{ task.created_at|date:"M d, H:i" }}
                    </small>
                </div>

                <strong>{{ task.title }}</strong>
                <p>{{ task.description|truncatechars:120 }}</p>

                {% with assignees=task.assigned_to.all %}
                    {% if assignees %}
                        <div class="assignees-container">
                            {% for assignee in assignees %}
                                <span class="programmer-icon" title="–î–∞–π—ã–Ω–¥–∞–ª–≥–∞–Ω: {{ assignee.username }}">
                                    <i class="fas fa-user-circle"></i>
                                </span>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endwith %}
                <form method="post" action="{% url 'update_status' task.id %}" class="update-status-form">
                    {% csrf_token %}
                    <select name="new_status">
                        <option value="TODO">Todo</option>
                        <option value="IN_PROGRESS">Progress</option>
                        <option value="DONE" selected>Done</option>
                    </select>
                    <button>–û–±–Ω–æ–≤–∏—Ç—å</button>
                </form>
                <button class="btn btn-danger btn-sm delete-btn" style="margin-top:5px;">”®—á“Ø—Ä“Ø“Ø</button>
            </div>
            {% empty %}<p></p>{% endfor %}
        </div>

    </div>

{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script>
        // --- –ñ–ê–õ–ü–´ –§–£–ù–ö–¶–ò–Ø–õ–ê–† ---
        function updateTaskCount(columnElement, change) {
            const header = columnElement.querySelector('h2');
            if (!header) return;

            const text = header.textContent;
            const match = text.match(/\((.*?)\)/);

            if (match) {
                let currentCount = parseInt(match[1]);
                let newCount = currentCount + change;

                const newText = text.replace(`(${currentCount})`, `(${newCount})`);
                header.textContent = newText;
            }
        }

        function createAssigneesHtml(usernames) {
            if (!usernames || usernames.length === 0) return '';

            let html = '';
            usernames.forEach(username => {
                html += `
                    <span class="programmer-icon" title="–î–∞–π—ã–Ω–¥–∞–ª–≥–∞–Ω: ${username}">
                        <i class="fas fa-user-circle"></i>
                    </span>
                `;
            });

            return `<div class="assignees-container">${html}</div>`;
        }

        function makeDraggable(card){
            card.setAttribute("draggable", "true");
            card.addEventListener("dragstart", e => {
                e.dataTransfer.setData("text/plain", card.dataset.id);
                setTimeout(() => card.classList.add("hide"), 0);
            });
            card.addEventListener("dragend", () => card.classList.remove("hide"));

            // Delete –∫–Ω–æ–ø–∫–∞ (”®—á“Ø—Ä“Ø“Ø –±–∞—Å–∫—ã—á—ã)
            const deleteBtn = card.querySelector(".delete-btn");
            if(deleteBtn){
                deleteBtn.addEventListener("click", async () => {
                    if(confirm("–ß—ã–Ω—ã–Ω–¥–∞ ”©—á“Ø—Ä”©—Å“Ø–∑–±“Ø?")){
                        // CSRF —Ç–æ–∫–µ–Ω–¥–∏ DOM'–¥–æ–Ω –∞–ª—É—É
                        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                        const response = await fetch(`/delete/${card.dataset.id}/`, {
                            method: "POST",
                            headers: {
                                "X-CSRFToken": csrfToken,
                                "X-Requested-With": "XMLHttpRequest"
                            }
                        });
                        const data = await response.json();
                        if(data.success) {
                            const currentColumn = card.closest(".kanban-column");
                            card.remove();
                            updateTaskCount(currentColumn, -1);
                        }
                        else alert("”®—á“Ø—Ä“Ø–ª–±”©–¥“Ø!");
                    }
                });
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const columns = document.querySelectorAll(".kanban-column");
            // ‚≠ê –≠–°–ö–ï–†–¢“Æ“Æ: –ë—É–ª ID 'base.html' —Ñ–∞–π–ª—ã“£—ã–∑–¥–∞–≥—ã –±–∞—Å–∫—ã—á–∫–∞ –¥–∞–ª –∫–µ–ª–∏—à–∏ –∫–µ—Ä–µ–∫!
            const toggleButton = document.getElementById("toggle-form-btn");
            const formContainer = document.getElementById("new-task-form-container");

            // --- –§–û–†–ú–ê–ù–´ –ê–ß–£–£/–ñ–ê–ë–£–£ ---
            // –≠–≥–µ—Ä–¥–µ —Ñ–æ—Ä–º–∞ –∂–µ –±–∞—Å–∫—ã—á —Ç–∞–±—ã–ª–≥–∞–Ω –±–æ–ª—Å–æ –≥–∞–Ω–∞ –∏—à—Ç–µ–π—Ç.
            if(toggleButton && formContainer){

                // ‚≠ê –û“¢–î–û–û/–¢–ï–ö–®–ï–†“Æ“Æ: –≠–≥–µ—Ä–¥–µ –±–∞—Å–∫—ã—á—Ç—ã–Ω —Ç–µ–∫—Å—Ç–∏ "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è" –±–æ–ª—Å–æ,
                // –∞–Ω–¥–∞ toggleButton.textContent "‚ûï –¢–∞–ø—à—ã—Ä–º–∞ –ö–æ—à—É—É" –±–æ–ª—É–ø ”©–∑–≥”©—Ä”©—Ç.
                // –ë—É–ª –∂–µ—Ä–¥–µ –ª–æ–≥–∏–∫–∞ —Ç—É—É—Ä–∞, –±–∏—Ä–æ–∫ –±–∞—Å–∫—ã—á—Ç—ã–Ω ID'—Å–∏ (toggle-form-btn) —ç“£ –º–∞–∞–Ω–∏–ª“Ø“Ø.

                toggleButton.addEventListener("click", () => {
                    formContainer.classList.toggle("hide");

                    if (formContainer.classList.contains("hide")) {
                        toggleButton.textContent = "‚ûï –¢–∞–ø—à—ã—Ä–º–∞ –ö–æ—à—É—É";
                    } else {
                        toggleButton.textContent = "‚ùå –§–æ—Ä–º–∞–Ω—ã –ñ–∞–±—É—É";
                    }
                });
            }


            document.querySelectorAll(".task-card").forEach(makeDraggable);

            // --- –¢–ê–ü–®–´–†–ú–ê–ù–´ –ë–ê–°–ö–ê–ù–î–ê –ú–û–î–ê–õ–î–´ –ß–´–ì–ê–†–£–£ ---
            // ... (–õ–æ–≥–∏–∫–∞ ”©–∑–≥”©—Ä“Ø“Ø—Å“Ø–∑) ...
            const taskDetailsModalElement = document.getElementById('taskDetailsModal');
            let taskDetailsModal = null;
            if (taskDetailsModalElement) {
                taskDetailsModal = new bootstrap.Modal(taskDetailsModalElement);
            }

            document.querySelectorAll(".task-card").forEach(card => {
                let isDragging = false;
                card.addEventListener('mousedown', () => isDragging = false);
                card.addEventListener('mousemove', () => isDragging = true);

                card.addEventListener("click", (e) => {
                    if (isDragging || e.target.closest('form') || e.target.closest('.delete-btn') || e.target.closest('.programmer-icon')) {
                        return;
                    }

                    if (!taskDetailsModal) return;

                    const id = card.dataset.id;
                    const title = card.dataset.title;
                    const shortDescription = card.dataset.shortDescription;
                    const fullDescription = card.dataset.fullDescription || '–ú–∞–∞–ª—ã–º–∞—Ç –∂–æ–∫';
                    const status = card.dataset.status;
                    const createdAt = card.dataset.createdAt;

                    const assignees = card.querySelectorAll('.programmer-icon');
                    let assigneesText = '–î–∞–π—ã–Ω–¥–∞–ª–≥–∞–Ω –∂–æ–∫';
                    if (assignees.length > 0) {
                        assigneesText = Array.from(assignees).map(span => span.getAttribute('title').replace('–î–∞–π—ã–Ω–¥–∞–ª–≥–∞–Ω: ', '')).join(', ');
                    }


                    document.getElementById('modal-id').textContent = id;
                    document.getElementById('modal-title').textContent = title;
                    document.getElementById('modal-status').textContent = status;
                    document.getElementById('modal-short-description').textContent = shortDescription;
                    document.getElementById('modal-full-description').textContent = fullDescription;
                    document.getElementById('modal-created-at').textContent = createdAt;
                    document.getElementById('modal-assignee').textContent = assigneesText;

                    taskDetailsModal.show();
                });
            });


            // --- DRAG & DROP –õ–û–ì–ò–ö–ê–°–´ --- (”®–∑–≥”©—Ä“Ø“Ø—Å“Ø–∑)
            columns.forEach(column => {
                column.addEventListener("dragover", e => { e.preventDefault(); column.classList.add("drag-over"); });
                column.addEventListener("dragleave", e => column.classList.remove("drag-over"));
                column.addEventListener("drop", e => {
                    e.preventDefault();
                    column.classList.remove("drag-over");
                    const id = e.dataTransfer.getData("text/plain");
                    const card = document.querySelector(`.task-card[data-id='${id}']`);

                    if (!card) return;

                    const oldColumn = card.closest(".kanban-column");
                    const newStatus = column.dataset.status;
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    fetch(`/update/${id}/`, {
                        method: "POST",
                        body: `new_status=${newStatus}&csrfmiddlewaretoken=${csrfToken}`,
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if(data.success) {
                            if (oldColumn && oldColumn !== column) {
                                updateTaskCount(oldColumn, -1);
                                updateTaskCount(column, 1);
                            }
                            column.appendChild(card);

                            card.classList.remove("todo", "progress", "done");
                            card.classList.add(newStatus.toLowerCase());
                            const select = card.querySelector('select[name="new_status"]');
                            if(select) select.value = newStatus;

                            card.dataset.status = newStatus;

                        } else {
                            alert("–°—Ç–∞—Ç—É—Å –∂–∞“£—ã—Ä—Ç—ã–ª–±–∞–π –∫–∞–ª–¥—ã! –ö–∞—Ç–∞: " + (data.error || "–ë–µ–ª–≥–∏—Å–∏–∑ –∫–∞—Ç–∞."));
                        }
                    })
                    .catch(error => {
                         console.error('Fetch error:', error);
                         alert("–¢–∞—Ä–º–∞–∫ –∫–∞—Ç–∞—Å—ã –∂–µ —Å–µ—Ä–≤–µ—Ä –∂–æ–æ–±—É –∫–∞—Ç–∞. –ö–æ–Ω—Å–æ–ª–¥—É —Ç–µ–∫—à–µ—Ä–∏“£–∏–∑.");
                    });
                });
            });

            // --- AJAX –ñ–ê“¢–´ –¢–ê–ü–®–´–†–ú–ê –ö–û–®–£–£ –õ–û–ì–ò–ö–ê–°–´ --- (”®–∑–≥”©—Ä“Ø“Ø—Å“Ø–∑)
            const form = document.getElementById("add-task-form");
            form.addEventListener("submit", async e => {
                e.preventDefault();
                const formData = new FormData(form);

                const response = await fetch(form.action, {
                    method: "POST",
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                const data = await response.json();

                if(data.success){
                    const column = document.querySelector(`.kanban-column[data-status="${data.status}"]`);
                    const div = document.createElement("div");
                    div.className = `task-card ${data.status.toLowerCase()}`;

                    div.dataset.id = data.id;
                    div.dataset.title = data.title;
                    div.dataset.shortDescription = data.description;
                    div.dataset.fullDescription = data.full_description || '';
                    div.dataset.status = data.status;
                    div.dataset.createdAt = data.created_at;

                    const assigneesHtml = createAssigneesHtml(data.assignee_usernames);

                    const authorHtml = data.author_username ?
                                        `<small class="text-muted task-author">–ê–≤—Ç–æ—Ä—É: <strong>${data.author_username}</strong></small>` :
                                        `<small class="text-muted task-author">–ê–≤—Ç–æ—Ä—É: <strong>(–ë–µ–ª–≥–∏—Å–∏–∑)</strong></small>`;

                    const timeHtml = data.created_at ?
                                        `<small class="text-secondary created-at-time" title="–¢“Ø–∑“Ø–ª–≥”©–Ω —É–±–∞–∫—ã—Ç—ã">
                                            <i class="fas fa-clock"></i> ${data.created_at}
                                        </small>` : '';

                    div.innerHTML = `
                                     <div class="task-info d-flex justify-content-between align-items-center mb-2">
                                         ${authorHtml}
                                         ${timeHtml}
                                     </div>
                                     <strong>${data.title}</strong>
                                     <p>${data.description}</p>
                                     ${assigneesHtml} <form method="post" action="/update/${data.id}/" class="update-status-form">
                                        <input type="hidden" name="csrfmiddlewaretoken" value="${data.csrf_token}">
                                        <select name="new_status">
                                            <option value="TODO" ${data.status=="TODO"?"selected":""}>Todo</option>
                                            <option value="IN_PROGRESS" ${data.status=="IN_PROGRESS"?"selected":""}>Progress</option>
                                            <option value="DONE" ${data.status=="DONE"?"selected":""}>Done</option>
                                        </select>
                                        <button>–û–±–Ω–æ–≤–∏—Ç—å</button>
                                     </form>
                                     <button class="btn btn-danger btn-sm delete-btn" style="margin-top:5px;">”®—á“Ø—Ä“Ø“Ø</button>`;

                    column.appendChild(div);
                    makeDraggable(div);
                    form.reset();

                    updateTaskCount(column, 1);

                    // ‚≠ê –§–û–†–ú–ê–ù–´ –ñ–ê–ë–£–£ –õ–û–ì–ò–ö–ê–°–´:
                    formContainer.classList.add("hide");
                    if (toggleButton) {
                        toggleButton.textContent = "‚ûï –¢–∞–ø—à—ã—Ä–º–∞ –ö–æ—à—É—É";
                    }

                } else {
                    alert("–¢–∞–ø—à—ã—Ä–º–∞ –∫–æ—à—É–ª–±–∞–π –∫–∞–ª–¥—ã!");
                    console.error(data.errors);
                }
            });
        });
    </script>
{% endblock %}
