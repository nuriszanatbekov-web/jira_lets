<!DOCTYPE html>
<html lang="ky">
<head>
    <meta charset="UTF-8">
    <title>Django Kanban –¢–∞–∫—Ç–∞—Å—ã</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        /* --- –°–ò–ó–î–ò–ù –ë–ò–†–ò–ù–ß–ò CSS –ë–õ–û–ì–£“¢–£–ó --- */
        body { background-color: #f4f5f7; font-family: "Segoe UI", Roboto, sans-serif; }
        .navbar { background: #0747A6; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;}
        .navbar-brand { color: #fff !important; font-weight: bold; font-size: 22px; }

        .add-task-btn {
            background: #0052CC;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .add-task-btn:hover { background: #0065FF; }

        .form-box { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 6px rgba(9,30,66,0.2); margin-bottom: 25px; }
        .kanban-columns { display: flex; gap: 20px; align-items: flex-start; width: 100%; }
        .kanban-column { background: #ebecf0; padding: 15px; border-radius: 6px; width: 33%; min-height: 400px; box-shadow: 0 1px 3px rgba(9,30,66,0.2); }
        .kanban-column h2 { font-size: 20px; color: #172b4d; margin-bottom: 15px; }
        .task-card {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 6px solid #4c9aff;
            box-shadow: 0 1px 3px rgba(9,30,66,0.2);
            transition: 0.2s;
            cursor: grab;
            min-width: 0;
            word-wrap: break-word;
        }
        .task-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(9,30,66,0.25); }
        .todo { border-left-color: #4c9aff; }
        .progress { border-left-color: #ff991f; }
        .done { border-left-color: #36b37e; }
        .task-card p { margin: 0; font-size: 15px; line-height: 1.4; }
        .task-card strong { font-size: 17px; display: block; margin-bottom: 6px; }

        /* --- –û“¢–î–û–û–õ–û–†: –°–ê–ù–î–ê–†–î–´–ù –ö–´–°–´–õ–£–£–°–£–ù –ñ–ê–ù–ê –ë–ê–°–ö–´–ß–¢–ê–†–î–´ –ñ–ê–ö–®–´–†–¢–£–£ --- */
        .task-card form {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #dcdcdc;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .task-card select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #b8b8b8;
            flex-grow: 1;
            min-width: 50px;
        }
        .task-card button {
            background: #0747A6;
            color: white;
            border: none;
            padding: 6px 8px; /* –ö–∏—á–∏–Ω–µ–∫–µ–π padding */
            border-radius: 4px;
            margin-left: 0;
            white-space: nowrap;
            font-size: 12px; /* –ö–∏—á–∏–Ω–µ–∫–µ–π —à—Ä–∏—Ñ—Ç */
            line-height: 1;
        }
        .task-card .delete-btn {
            background: #ff5248;
            margin-top: 5px;
            display: block;
            width: 100%;
        }
        /* --- –û“¢–î–û–û–õ–û–† –ê–Ø–ö–¢–ê–î–´ --- */

        .drag-over { background-color: #dfe6f0; }
        .hide { display: none; }
    </style>
    <style>
    /* --- –°–ò–ó–î–ò–ù –≠–ö–ò–ù–ß–ò (–ö–ê–†–ê“¢–ì–´) CSS –ë–õ–û–ì–£“¢–£–ó --- */
    body {
        background-color: #172B4D; /* –ö–∞—Ä–∞“£–≥—ã –∫”©–∫ —Ñ–æ–Ω */
        font-family: "Segoe UI", Roboto, sans-serif;
        color: #f4f5f7; /* –ñ–∞–ª–ø—ã —Ç–µ–∫—Å—Ç—Ç–∏–Ω —Ç“Ø—Å“Ø –∞–∫–∫–∞ ”©–∑–≥”©—Ä—Ç“Ø–ª–¥“Ø */
    }

    .navbar { background: #0747A6; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;}
    .navbar-brand { color: #fff !important; font-weight: bold; font-size: 22px; }

    .add-task-btn {
        background: #0052CC;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .add-task-btn:hover { background: #0065FF; }

    /* --- –§–û–†–ú–ê –ñ–ê–ù–ê –ö–û–õ–û–ù–ö–ê –ö–û–ù–¢–ï–ô–ù–ï–†–õ–ï–†–ò–ù–î–ï–ì–ò ”®–ó–ì”®–†–¢“Æ“Æ–õ”®–† --- */
    .form-box {
        background: #283e60; /* –§–æ—Ä–º–∞–Ω—ã–Ω —Ñ–æ–Ω—É –±–∏—Ä –∞–∑ –∞—á—ã–≥—ã—Ä–∞–∞–∫ –∫–∞—Ä–∞ –∫”©–∫ */
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.5); /* –ö”©–º“Ø—Å–∫”©–Ω“Ø –∫“Ø—á”©—Ç—Ç“Ø–∫ */
        margin-bottom: 25px;
    }
    .kanban-columns { display: flex; gap: 20px; align-items: flex-start; width: 100%; }
    .kanban-column {
        background: #21304A; /* –ö–æ–ª–æ–Ω–∫–∞–Ω—ã–Ω —Ñ–æ–Ω—É –∫–∞—Ä–∞ –∫”©–∫ */
        padding: 15px;
        border-radius: 6px;
        width: 33%;
        min-height: 400px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.4);
    }
    .kanban-column h2 {
        font-size: 20px;
        color: #f4f5f7; /* –ö–æ–ª–æ–Ω–∫–∞–Ω—ã–Ω –∞—Ç–∞–ª—ã—à—ã–Ω –∞–∫ –∫—ã–ª–¥—ã–∫ */
        margin-bottom: 15px;
    }

    /* --- –¢–ê–ü–®–´–†–ú–ê –ö–ê–†–¢–û–ß–ö–ê–õ–ê–†–´–ù–´–ù ”®–ó–ì”®–†–¢“Æ“Æ–õ”®–†“Æ --- */
    .task-card {
        background: #384C6C; /* –ö–∞—Ä—Ç–æ—á–∫–∞–Ω—ã–Ω —Ñ–æ–Ω—É –∞–Ω–¥–∞–Ω –¥–∞ –∞—á—ã–≥—ã—Ä–∞–∞–∫ */
        color: #f4f5f7; /* –ö–∞—Ä—Ç–æ—á–∫–∞–¥–∞–≥—ã —Ç–µ–∫—Å—Ç –∞–∫ */
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 12px;
        border-left: 6px solid #4c9aff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        transition: 0.2s;
        cursor: grab;
        min-width: 0;
        word-wrap: break-word;
    }
    .task-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.6); }
    .todo { border-left-color: #4c9aff; }
    .progress { border-left-color: #ff991f; }
    .done { border-left-color: #36b37e; }
    .task-card p { margin: 0; font-size: 15px; line-height: 1.4; }
    .task-card strong { font-size: 17px; display: block; margin-bottom: 6px; }

    .task-card form {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed #dcdcdc;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    /* –°–µ–ª–µ–∫—Ç –∂–∞–Ω–∞ –ò–Ω–ø—É—Ç—Ç–∞—Ä–¥—ã –∫–∞—Ä–∞“£–≥—ã —Ñ–æ–Ω–≥–æ —ã–ª–∞–π—ã–∫—Ç–∞—à—Ç—ã—Ä—É—É */
    .task-card select, .form-box input, .form-box textarea, .form-box select {
        padding: 5px;
        border-radius: 4px;
        border: 1px solid #5e7090;
        background-color: #21304A; /* –§–æ–Ω –∫–∞—Ä–∞“£–≥—ã */
        color: #f4f5f7; /* –¢–µ–∫—Å—Ç –∞–∫ */
        flex-grow: 1;
        min-width: 50px;
    }

    .task-card button {
        background: #0747A6;
        color: white;
        padding: 6px 8px;
        border-radius: 4px;
        margin-left: 0;
        white-space: nowrap;
        font-size: 12px;
        line-height: 1;
    }
    .task-card .delete-btn {
        background: #ff5248;
        margin-top: 5px;
        display: block;
        width: 100%;
    }

    .drag-over { background-color: #283e60; } /* Drag-over —Ñ–æ–Ω—É–Ω –¥–∞ –∫–∞—Ä–∞“£–≥—ã–ª–∞—Ç—É—É */
    .hide { display: none; }

    /* --- –ñ–ê“¢–´ –ö–û–®–£–õ–î–£: –ê–í–¢–û–†–î–£–ù –°–¢–ò–õ–ò --- */
    .task-card .task-author {
        font-size: 13px;
        color: #A6C5E2; /* –ê—á—ã–∫ –∫”©–∫ —Ç“Ø—Å */
        margin-bottom: 8px; /* –ö–∞—Ä—Ç–∞–Ω—ã–Ω –∞—Ç–∞–ª—ã—à—ã–Ω–∞–Ω –∞—Ä–∞–ª—ã–∫ */
        padding-bottom: 5px;
        border-bottom: 1px dotted #5e7090; /* –ñ–µ“£–∏–ª —Å—ã–∑—ã–∫ –º–µ–Ω–µ–Ω –±”©–ª“Ø“Ø */
        font-weight: 500;
    }
    .task-card .task-author strong {
        font-size: 13px; /* Strong “Ø—á“Ø–Ω —à—Ä–∏—Ñ—Ç—Ç–∏ –∫–∏—á–∏—Ä–µ–π—Ç“Ø“Ø */
        display: inline; /* –ê—Ç–∞–ª—ã—à –º–µ–Ω–µ–Ω –±–∏—Ä —Å–∞–ø—Ç–∞ —Ç—É—Ä—É—É—Å—É “Ø—á“Ø–Ω */
    }
    /* --- –û“¢–î–û–û–õ–û–†: –ú–û–î–ê–õ–î–ê–ì–´ –¢–ï–ö–°–¢–¢–ò –û“¢–î–û–û --- */
    .modal-body p {
        word-break: break-word; /* –£–∑—É–Ω —Å”©–∑–¥”©—Ä–¥“Ø —Å—ã–Ω–¥—ã—Ä—É—É */
        overflow-wrap: break-word; /* –£–∑—É–Ω —Å”©–∑–¥”©—Ä–¥“Ø –∂—ã–ª–¥—ã—Ä—É—É */
    }
    /* --- –û“¢–î–û–û –ê–Ø–ö–¢–ê–î–´ --- */
    </style>
</head>
<body>
<nav class="navbar px-4">
    <a class="navbar-brand" href="#">–î–∂–∏—Ä–∞-–°—Ç–∏–ª—å –ö–∞–Ω–±–∞–Ω</a>
    <button id="toggle-form-btn" class="add-task-btn">
        ‚ûï –¢–∞–ø—à—ã—Ä–º–∞ –ö–æ—à—É—É
    </button>
</nav>

<div class="modal fade" id="taskDetailsModal" tabindex="-1" aria-labelledby="taskDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background-color: #21304A; color: #f4f5f7;">
            <div class="modal-header" style="border-bottom: 1px solid #384C6C;">
                <h5 class="modal-title" id="taskDetailsModalLabel">–¢–∞–ø—à—ã—Ä–º–∞: <span id="modal-title"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body">
                <p><strong>ID:</strong> <span id="modal-id"></span></p>
                <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="modal-status"></span></p>
                <hr style="border-top: 1px solid #384C6C;">
                <h5>–ö—ã—Å–∫–∞—á–∞ –°“Ø—Ä”©—Ç—Ç”©–º”© (–ö–∞—Ä—Ç–∞–¥–∞ –∫”©—Ä“Ø–Ω–≥”©–Ω):</h5>
                <p id="modal-short-description" style="white-space: pre-wrap;"></p>
                <hr style="border-top: 1px solid #384C6C;">
                <h5>–ü–æ–¥—Ä–æ–±–Ω–µ–µ (–¢–æ–ª—É–∫ –°“Ø—Ä”©—Ç—Ç”©–º”©):</h5>
                <p id="modal-full-description" style="white-space: pre-wrap;">–ú–∞–∞–ª—ã–º–∞—Ç –∂–æ–∫</p>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #384C6C;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background: #384C6C; border: none;">–ñ–∞–±—É—É</button>
            </div>
        </div>
    </div>
</div>
<div class="container mt-4">
    <div id="new-task-form-container" class="form-box hide">
        <h3 class="mb-3">‚ûï –ñ–∞“£—ã –¢–∞–ø—à—ã—Ä–º–∞ –ö–æ—à—É—É</h3>
        <form id="add-task-form" method="post" action="{% url 'kanban_board' %}">
            {% csrf_token %}
            {{ form.as_p }}
            <button class="btn btn-primary">–¢–∞–ø—à—ã—Ä–º–∞ –∫–æ—à—É—É</button>
        </form>
    </div>

    <div class="kanban-columns">
        <div class="kanban-column" data-status="TODO">
            <h2>üü¶ Todo ({{ todo_tasks|length }})</h2>
            {% for task in todo_tasks %}
            <div class="task-card todo"
                data-id="{{ task.id }}"
                data-title="{{ task.title }}"
                data-short-description="{{ task.description|truncatechars:120 }}"
                data-full-description="{{ task.full_description|default:'' }}"
                data-status="TODO">

                <p class="task-author">
                    –ê–≤—Ç–æ—Ä—É:
                    <strong>
                    {% if task.author %}
                        {{ task.author.username }}
                    {% else %}
                        (–ë–µ–ª–≥–∏—Å–∏–∑)
                    {% endif %}
                    </strong>
                </p>
                <strong>{{ task.title }}</strong>
                <p>{{ task.description|truncatechars:120 }}</p>
                <form method="post" action="{% url 'update_status' task.id %}" class="update-status-form">
                    {% csrf_token %}
                    <select name="new_status">
                        <option value="TODO" selected>Todo</option>
                        <option value="IN_PROGRESS">Progress</option>
                        <option value="DONE">Done</option>
                    </select>
                    <button>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
                </form>
                <button class="btn btn-danger btn-sm delete-btn" style="margin-top:5px;">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
            </div>
            {% empty %}<p></p>{% endfor %}
        </div>

        <div class="kanban-column" data-status="IN_PROGRESS">
            <h2>üüß Progress ({{ progress_tasks|length }})</h2>
            {% for task in progress_tasks %}
            <div class="task-card progress"
                data-id="{{ task.id }}"
                data-title="{{ task.title }}"
                data-short-description="{{ task.description|truncatechars:120 }}"
                data-full-description="{{ task.full_description|default:'' }}"
                data-status="IN_PROGRESS">

                <p class="task-author">
                    –ê–≤—Ç–æ—Ä—É:
                    <strong>
                    {% if task.author %}
                        {{ task.author.username }}
                    {% else %}
                        (–ë–µ–ª–≥–∏—Å–∏–∑)
                    {% endif %}
                    </strong>
                </p>
                <strong>{{ task.title }}</strong>
                <p>{{ task.description|truncatechars:120 }}</p>
                <form method="post" action="{% url 'update_status' task.id %}" class="update-status-form">
                    {% csrf_token %}
                    <select name="new_status">
                        <option value="TODO">Todo</option>
                        <option value="IN_PROGRESS" selected>Progress</option>
                        <option value="DONE">Done</option>
                    </select>
                    <button>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
                </form>
                <button class="btn btn-danger btn-sm delete-btn" style="margin-top:5px;">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
            </div>
            {% empty %}<p></p>{% endfor %}
        </div>

        <div class="kanban-column" data-status="DONE">
            <h2>üü© Done ({{ done_tasks|length }})</h2>
            {% for task in done_tasks %}
            <div class="task-card done"
                data-id="{{ task.id }}"
                data-title="{{ task.title }}"
                data-short-description="{{ task.description|truncatechars:120 }}"
                data-full-description="{{ task.full_description|default:'' }}"
                data-status="DONE">

                <p class="task-author">
                    –ê–≤—Ç–æ—Ä—É:
                    <strong>
                    {% if task.author %}
                        {{ task.author.username }}
                    {% else %}
                        (–ë–µ–ª–≥–∏—Å–∏–∑)
                    {% endif %}
                    </strong>
                </p>
                <strong>{{ task.title }}</strong>
                <p>{{ task.description|truncatechars:120 }}</p>
                <form method="post" action="{% url 'update_status' task.id %}" class="update-status-form">
                    {% csrf_token %}
                    <select name="new_status">
                        <option value="TODO">Todo</option>
                        <option value="IN_PROGRESS">Progress</option>
                        <option value="DONE" selected>Done</option>
                    </select>
                    <button>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
                </form>
                <button class="btn btn-danger btn-sm delete-btn" style="margin-top:5px;">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
            </div>
            {% empty %}<p></p>{% endfor %}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
function updateTaskCount(columnElement, change) {
    const header = columnElement.querySelector('h2');
    if (!header) return;

    const text = header.textContent;
    const match = text.match(/\((.*?)\)/);

    if (match) {
        let currentCount = parseInt(match[1]);
        let newCount = currentCount + change;

        const newText = text.replace(`(${currentCount})`, `(${newCount})`);
        header.textContent = newText;
    }
}

document.addEventListener("DOMContentLoaded", () => {

    const columns = document.querySelectorAll(".kanban-column");
    const toggleButton = document.getElementById("toggle-form-btn");
    const formContainer = document.getElementById("new-task-form-container");

    toggleButton.addEventListener("click", () => {
        formContainer.classList.toggle("hide");

        if (formContainer.classList.contains("hide")) {
            toggleButton.textContent = "‚ûï –¢–∞–ø—à—ã—Ä–º–∞ –ö–æ—à—É—É";
        } else {
            toggleButton.textContent = "‚ùå –§–æ—Ä–º–∞–Ω—ã –ñ–∞–±—É—É";
        }
    });


    function makeDraggable(card){
        card.setAttribute("draggable", "true");
        card.addEventListener("dragstart", e => {
            e.dataTransfer.setData("text/plain", card.dataset.id);
            setTimeout(() => card.classList.add("hide"), 0);
        });
        card.addEventListener("dragend", () => card.classList.remove("hide"));

        // Delete –∫–Ω–æ–ø–∫–∞ (–û—Ç–∫–ª—é—á–∏—Ç—å –±–∞—Å–∫—ã—á—ã)
        const deleteBtn = card.querySelector(".delete-btn");
        if(deleteBtn){
            deleteBtn.addEventListener("click", async () => {
                if(confirm("–ß—ã–Ω—ã–Ω–¥–∞ ”©—á“Ø—Ä”©—Å“Ø–∑–±“Ø?")){
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    const response = await fetch(`/delete/${card.dataset.id}/`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": csrfToken,
                            "X-Requested-With": "XMLHttpRequest"
                        }
                    });
                    const data = await response.json();
                    if(data.success) {
                        const currentColumn = card.closest(".kanban-column");
                        card.remove();
                        updateTaskCount(currentColumn, -1);
                    }
                    else alert("”®—á“Ø—Ä“Ø–ª–±”©–¥“Ø!");
                }
            });
        }
    }

    document.querySelectorAll(".task-card").forEach(makeDraggable);

    // --- –¢–ê–ü–®–´–†–ú–ê–ù–´ –ë–ê–°–ö–ê–ù–î–ê –ú–û–î–ê–õ–î–´ –ß–´–ì–ê–†–£–£ ---
    const taskDetailsModalElement = document.getElementById('taskDetailsModal');
    const taskDetailsModal = new bootstrap.Modal(taskDetailsModalElement);

    document.querySelectorAll(".task-card").forEach(card => {
        let isDragging = false;
        card.addEventListener('mousedown', () => isDragging = false);
        card.addEventListener('mousemove', () => isDragging = true);

        card.addEventListener("click", (e) => {
            if (isDragging || e.target.closest('form') || e.target.closest('.delete-btn')) {
                return;
            }

            const id = card.dataset.id;
            const title = card.dataset.title;
            const shortDescription = card.dataset.shortDescription;
            const fullDescription = card.dataset.fullDescription || '–ú–∞–∞–ª—ã–º–∞—Ç –∂–æ–∫';
            const status = card.dataset.status;

            document.getElementById('modal-id').textContent = id;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-status').textContent = status;
            document.getElementById('modal-short-description').textContent = shortDescription;
            document.getElementById('modal-full-description').textContent = fullDescription;

            taskDetailsModal.show();
        });
    });
    // --- –ú–û–î–ê–õ –õ–û–ì–ò–ö–ê–°–´ –ê–Ø–ö–¢–ê–î–´ ---

    columns.forEach(column => {
        column.addEventListener("dragover", e => { e.preventDefault(); column.classList.add("drag-over"); });
        column.addEventListener("dragleave", e => column.classList.remove("drag-over"));
        column.addEventListener("drop", e => {
            e.preventDefault();
            column.classList.remove("drag-over");
            const id = e.dataTransfer.getData("text/plain");
            const card = document.querySelector(`.task-card[data-id='${id}']`);

            const oldColumn = card.closest(".kanban-column");
            const newStatus = column.dataset.status;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(`/update/${id}/`, {
                method: "POST",
                body: `new_status=${newStatus}&csrfmiddlewaretoken=${csrfToken}`,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            }).then(response => {
                if(response.ok) {
                    if (oldColumn && oldColumn !== column) {
                        updateTaskCount(oldColumn, -1);
                        updateTaskCount(column, 1);
                    }
                    column.appendChild(card);
                    // –°–¢–ò–õ–î–ï–†–î–ò –ñ–ê“¢–´–†–¢–£–£
                    card.classList.remove("todo", "progress", "done");
                    card.classList.add(newStatus.toLowerCase());
                    const select = card.querySelector('select[name="new_status"]');
                    if(select) select.value = newStatus;

                    card.dataset.status = newStatus;

                } else {
                    alert("–°—Ç–∞—Ç—É—Å –∂–∞“£—ã—Ä—Ç—ã–ª–±–∞–π –∫–∞–ª–¥—ã!");
                }
            });
        });
    });

    // --- –ñ–ê“¢–´ –ö–û–®–£–õ–î–£: "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ" –±–∞—Å–∫—ã—á—ã –∞—Ä–∫—ã–ª—É—É —Å—Ç–∞—Ç—É—Å ”©–∑–≥”©—Ä—Ç“Ø“Ø –ª–æ–≥–∏–∫–∞—Å—ã ---
    document.querySelectorAll(".update-status-form").forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const card = this.closest('.task-card');
            const oldColumn = card.closest('.kanban-column');
            const formData = new FormData(this);
            const newStatus = formData.get('new_status');
            const csrfToken = formData.get('csrfmiddlewaretoken');

            const response = await fetch(this.action, {
                method: "POST",
                body: `new_status=${newStatus}&csrfmiddlewaretoken=${csrfToken}`,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            });

            if (response.ok) {
                const targetColumn = document.querySelector(`.kanban-column[data-status="${newStatus}"]`);

                if (oldColumn !== targetColumn) {
                    // –°–∞–Ω–¥–∞—Ä–¥—ã –∂–∞“£—ã—Ä—Ç—É—É
                    updateTaskCount(oldColumn, -1);
                    updateTaskCount(targetColumn, 1);

                    // –ö–∞—Ä—Ç–∞–Ω—ã –∂–∞“£—ã –∫–æ–ª–æ–Ω–∫–∞–≥–∞ –∂—ã–ª–¥—ã—Ä—É—É
                    targetColumn.appendChild(card);
                }

                // –°–¢–ò–õ–î–ï–†–î–ò –ñ–ê–ù–ê –ê–¢–†–ò–ë–£–¢–¢–ê–†–î–´ –ñ–ê“¢–´–†–¢–£–£
                card.classList.remove("todo", "progress", "done");
                card.classList.add(newStatus.toLowerCase());
                card.dataset.status = newStatus;

            } else {
                alert("–°—Ç–∞—Ç—É—Å –∂–∞“£—ã—Ä—Ç—ã–ª–±–∞–π –∫–∞–ª–¥—ã!");
            }
        });
    });
    // --- –ñ–ê“¢–´ –ö–û–®–£–õ–î–£ –ê–Ø–ö–¢–ê–î–´ ---


    // AJAX –∫–æ—à—É—É
    const form = document.getElementById("add-task-form");
    form.addEventListener("submit", async e => {
        e.preventDefault();
        const formData = new FormData(form);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const fullDescription = formData.get('full_description') || '';

        const response = await fetch(form.action, {
            method: "POST",
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await response.json();

        if(data.success){
            const column = document.querySelector(`.kanban-column[data-status="${data.status}"]`);
            const div = document.createElement("div");
            div.className = `task-card ${data.status.toLowerCase()}`;

            div.dataset.id = data.id;
            div.dataset.title = data.title;
            div.dataset.shortDescription = data.description;
            div.dataset.fullDescription = fullDescription;
            div.dataset.status = data.status;

            // –ñ–∞“£—ã –∫–æ—à—É–ª–≥–∞–Ω –∫–∞—Ä—Ç–∞–≥–∞ –∞–≤—Ç–æ—Ä –º–∞–∞–ª—ã–º–∞—Ç—ã–Ω –∫–æ—à—É—É (—ç–≥–µ—Ä —Å–µ—Ä–≤–µ—Ä —Ç–∞—Ä–∞–ø—Ç–∞–Ω –±–µ—Ä–∏–ª—Å–µ)
            const authorHtml = data.author_username ?
                                `<p class="task-author">–ê–≤—Ç–æ—Ä—É: <strong>${data.author_username}</strong></p>` :
                                `<p class="task-author">–ê–≤—Ç–æ—Ä—É: <strong>(–ë–µ–ª–≥–∏—Å–∏–∑)</strong></p>`;


            div.innerHTML = `${authorHtml}
                             <strong>${data.title}</strong>
                             <p>${data.description}</p>
                             <form method="post" action="/update/${data.id}/" class="update-status-form">
                                <select name="new_status">
                                    <option value="TODO" ${data.status=="TODO"?"selected":""}>Todo</option>
                                    <option value="IN_PROGRESS" ${data.status=="IN_PROGRESS"?"selected":""}>Progress</option>
                                    <option value="DONE" ${data.status=="DONE"?"selected":""}>Done</option>
                                </select>
                                <button>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
                             </form>
                             <button class="btn btn-danger btn-sm delete-btn" style="margin-top:5px;">–û—Ç–∫–ª—é—á–∏—Ç—å</button>`;
            column.appendChild(div);
            makeDraggable(div);
            form.reset();

            updateTaskCount(column, 1);

            formContainer.classList.add("hide");
            toggleButton.textContent = "‚ûï –¢–∞–ø—à—ã—Ä–º–∞ –ö–æ—à—É—É";

        } else alert("–¢–∞–ø—à—ã—Ä–º–∞ –∫–æ—à—É–ª–±–∞–π –∫–∞–ª–¥—ã!");
    });
});
</script>
</body>
</html>